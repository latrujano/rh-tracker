(()=>{if(window.__RH_OT?.x){window.__RH_OT.x();return}
const C={ms:80,max:6000},$=s=>document.querySelector(s),A=s=>[...document.querySelectorAll(s)];
const T=s=>String(s||"").replace(/\s+/g," ").trim(),R=/\$\s*([0-9]*\.?[0-9]+)/,P=/(-?\d+(?:\.\d+)?)\s*%/,M=/×\s*([0-9,]+)/,N=/(-?\d+(?:\.\d+)?)/,I=/(-?\d[\d,]*)/;
const nodes=()=>A("div,span,p,dt,dd,th,td,h1,h2,h3,h4,h5").filter(n=>n&&n.textContent);
const lbl=t=>nodes().find(n=>n.textContent.trim()===t),lblR=re=>nodes().find(n=>re.test(n.textContent.trim()));
const vc=n=>{if(!n)return null;let c=n.closest("div,section,li,dl,tr")||n.parentElement;for(let i=0;i<7&&c;i++){let t=T(c.innerText||c.textContent);if(t&&t!==n.textContent.trim())return c;c=c.parentElement}return n.parentElement};
const ex=t=>{let n=lbl(t);if(!n)return null;let c=vc(n);if(!c)return null;let s=T(c.innerText||c.textContent);
return s.replace(/\b(Bid|Ask|Mark|Last trade|Implied volatility|Volume|Open interest|Delta|Gamma|Theta|Vega|Rho)\b/g,"").trim()||null};
const exR=re=>{let n=lblR(re);if(!n)return null;let c=vc(n);if(!c)return null;let s=T(c.innerText||c.textContent);return s.replace(re,"").trim()||null};
const pm=t=>{let raw=ex(t);if(!raw)return [null,null];let m=R.exec(raw),s=M.exec(raw);return [m?+m[1]:null,s?+String(s[1]).replace(/,/g,""):null]};
const p$=t=>{let raw=ex(t),m=raw?R.exec(raw):null;return m?+m[1]:null};
const p%=t=>{let raw=ex(t);if(!raw)return null;let m=P.exec(raw)||N.exec(raw);return m?+m[1]:null};
const pI=t=>{let raw=ex(t),m=raw?I.exec(raw):null;return m?+String(m[1]).replace(/,/g,""):null};
const pN=t=>{let raw=ex(t),m=raw?N.exec(raw):null;return m?+m[1]:null};
const und=()=>{let raw=exR(/^Current\s+[A-Z]{1,6}\s+price$/),m=raw?R.exec(raw):null;return m?+m[1]:null};
const be=()=>{let raw=exR(/^[A-Z]{1,6}\s+breakeven\s+price$/i),m=raw?R.exec(raw):null;return m?+m[1]:null};
const k=()=>{let h=A("h1,h2,h3").map(n=>T(n.textContent)).join(" | ");let m=/\b[A-Z]{1,6}\s*\$?\s*([0-9]{2,6}(?:\.\d+)?)\s*(Call|Put)\b/i.exec(h);return m?+m[1]:null};
const ts=()=>{let d=new Date();return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0")+" "+String(d.getHours()).padStart(2,"0")+":"+String(d.getMinutes()).padStart(2,"0")+":"+String(d.getSeconds()).padStart(2,"0")+"."+String(d.getMilliseconds()).padStart(3,"0")};
const fmt$=v=>v==null?"—":"$"+(+v).toFixed(4),fmt2$=v=>v==null?"—":"$"+(+v).toFixed(2),fmt%=v=>v==null?"—":(+v).toFixed(3)+"%";
let st={p:0,rows:[],key:""},box=$("#rhOT"); if(box) box.remove();
box=document.createElement("div");box.id="rhOT";box.style="position:fixed;top:12px;right:12px;z-index:2147483647;background:rgba(20,20,20,.92);color:#fff;font:12px/1.35 system-ui;border:1px solid rgba(255,255,255,.15);border-radius:12px;padding:10px;min-width:360px;box-shadow:0 10px 28px rgba(0,0,0,.4)";
box.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;gap:8px"><b>RH Options Tracker</b>
<div style="display:flex;gap:6px">
<button id=rhP style="cursor:pointer;border:0;background:rgba(255,255,255,.12);color:#fff;border-radius:8px;padding:4px 8px">Pause</button>
<button id=rhX style="cursor:pointer;border:0;background:rgba(255,255,255,.12);color:#fff;border-radius:8px;padding:4px 8px">X</button></div></div>
<div id=rhS style="margin-top:6px;opacity:.85">Starting…</div>
<div style="display:grid;grid-template-columns:110px 1fr;gap:4px 10px;margin-top:8px;align-items:center">
<div style="opacity:.75">Underlying</div><div id=rhU>—</div>
<div style="opacity:.75">Strike</div><div id=rhK>—</div>
<div style="opacity:.75">Breakeven</div><div id=rhB>—</div>
<div style="opacity:.75">Bid</div><div id=rhBid>—</div>
<div style="opacity:.75">Ask</div><div id=rhAsk>—</div>
<div style="opacity:.75">Mark</div><div id=rhM>—</div>
<div style="opacity:.75">Last</div><div id=rhL>—</div>
<div style="opacity:.75">Spread</div><div id=rhSp>—</div>
<div style="opacity:.75">Mid</div><div id=rhMid>—</div>
<div style="opacity:.75">IV</div><div id=rhIV>—</div>
<div style="opacity:.75">Volume</div><div id=rhV>—</div>
<div style="opacity:.75">Open int</div><div id=rhOI>—</div>
<div style="opacity:.75">Delta</div><div id=rhD>—</div>
<div style="opacity:.75">Gamma</div><div id=rhG>—</div>
<div style="opacity:.75">Theta</div><div id=rhT>—</div>
<div style="opacity:.75">Vega</div><div id=rhVe>—</div>
<div style="opacity:.75">Rho</div><div id=rhR>—</div>
<div style="opacity:.75">Last sample</div><div id=rhTime>—</div>
<div style="opacity:.75">Rows</div><div id=rhN>0</div>
</div>
<div style="margin-top:10px;display:flex;gap:6px;flex-wrap:wrap">
<button id=rhC style="cursor:pointer;border:0;background:rgba(255,255,255,.12);color:#fff;border-radius:10px;padding:6px 10px">Copy CSV</button>
<button id=rhDnl style="cursor:pointer;border:0;background:rgba(255,255,255,.12);color:#fff;border-radius:10px;padding:6px 10px">Download CSV</button>
</div>`;
document.body.appendChild(box);
const q=s=>box.querySelector(s);
const csv=()=>["timestamp,underlying_price,breakeven_price,strike,bid_price,bid_size,ask_price,ask_size,mark,last_trade,spread,mid,iv_pct,volume,open_interest,delta,gamma,theta,vega,rho"].concat(st.rows.map(r=>[
r.t্চ,r.u??"",r.be??"",r.k??"",r.bp??"",r.bs??"",r.ap??"",r.as??"",r.m??"",r.l??"",r.sp??"",r.mid??"",r.iv??"",r.v??"",r.oi??"",r.d??"",r.g??"",r.th??"",r.ve??"",r.r??""
].join(","))).join("\n");
async function copy(){let c=csv();try{await navigator.clipboard.writeText(c);alert("Copied CSV.")}catch(e){prompt("Copy CSV:",c)}}
function dl(){let c=csv(),b=new Blob([c],{type:"text/csv"}),u=URL.createObjectURL(b),a=document.createElement("a");a.href=u;a.download="rh_option_metrics_"+Date.now()+".csv";a.click();setTimeout(()=>URL.revokeObjectURL(u),800)}
let timer=null,obs=null;
function sample(src){
 if(st.p) return;
 let t=ts(),[bp,bs]=pm("Bid"),[ap,as]=pm("Ask"),m=p$("Mark"),l=p$("Last trade"),iv=p%("Implied volatility");
 let sp=(bp!=null&&ap!=null)?(ap-bp):null,mid=(bp!=null&&ap!=null)?((ap+bp)/2):null;
 let rec={t,u:und(),be:be(),k:k(),bp,bs,ap,as,m,l,sp,mid,iv,v:pI("Volume"),oi:pI("Open interest"),d:pN("Delta"),g:pN("Gamma"),th:pN("Theta"),ve:pN("Vega"),r:pN("Rho")};
 let key=[rec.u,rec.be,rec.k,rec.bp,rec.bs,rec.ap,rec.as,rec.m,rec.l,rec.iv,rec.v,rec.oi,rec.d,rec.g,rec.th,rec.ve,rec.r].join("|");
 if(key===st.key && src!=="poll") return; st.key=key;
 q("#rhS").textContent="Running ("+src+")";
 q("#rhU").textContent=fmt2$(rec.u); q("#rhK").textContent=rec.k??"—"; q("#rhB").textContent=fmt2$(rec.be);
 q("#rhBid").textContent=rec.bp!=null?(fmt$(rec.bp)+(rec.bs!=null?(" × "+rec.bs):"")):"—";
 q("#rhAsk").textContent=rec.ap!=null?(fmt$(rec.ap)+(rec.as!=null?(" × "+rec.as):"")):"—";
 q("#rhM").textContent=fmt$(rec.m); q("#rhL").textContent=fmt$(rec.l);
 q("#rhSp").textContent=rec.sp!=null?fmt$(rec.sp):"—"; q("#rhMid").textContent=rec.mid!=null?fmt$(rec.mid):"—";
 q("#rhIV").textContent=fmt%(rec.iv); q("#rhV").textContent=rec.v??"—"; q("#rhOI").textContent=rec.oi??"—";
 q("#rhD").textContent=rec.d!=null?(+rec.d).toFixed(4):"—"; q("#rhG").textContent=rec.g!=null?(+rec.g).toFixed(4):"—";
 q("#rhT").textContent=rec.th!=null?(+rec.th).toFixed(4):"—"; q("#rhVe").textContent=rec.ve!=null?(+rec.ve).toFixed(4):"—"; q("#rhR").textContent=rec.r!=null?(+rec.r).toFixed(4):"—";
 q("#rhTime").textContent=rec.t; st.rows.push(rec); if(st.rows.length>C.max) st.rows.shift(); q("#rhN").textContent=String(st.rows.length);
}
q("#rhP").onclick=()=>{st.p=!st.p;q("#rhP").textContent=st.p?"Resume":"Pause";q("#rhS").textContent=st.p?"Paused":"Running"};
q("#rhC").onclick=copy; q("#rhDnl").onclick=dl;
function close(){try{obs&&obs.disconnect()}catch{} try{timer&&clearInterval(timer)}catch{} box.remove(); window.__RH_OT=null}
q("#rhX").onclick=close;
obs=new MutationObserver(()=>sample("observer"));obs.observe(document.body,{childList:true,subtree:true,characterData:true});
timer=setInterval(()=>sample("poll"),C.ms);sample("init");
window.__RH_OT={x:close};
})();
