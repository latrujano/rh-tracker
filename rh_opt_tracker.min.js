(()=>{if(window.__RH_OPT_TRACKER__?.close){window.__RH_OPT_TRACKER__.close();return;}const CFG={pollMs:50,maxPoints:6000,chartHeight:70,chartWidth:280};const pad=n=>String(n).padStart(2,"0");const ts=()=>{const d=new Date();return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}.${String(d.getMilliseconds()).padStart(3,"0")}`};const moneyRe=/\$\s*([0-9]*\.?[0-9]+)/;const pctRe=/(-?\d+(?:\.\d+)?)\s*%/;const multRe=/×\s*([0-9,]+)/;const numRe=/(-?\d+(?:\.\d+)?)/;const intRe=/(-?\d[\d,]*)/;function normText(s){return String(s||"").replace(/\s+/g," ").trim();}function findLabelNode(label){const nodes=[...document.querySelectorAll("div,span,p,dt,dd,th,td,h1,h2,h3,h4,h5,h6")];return nodes.find(n=>n&&n.textContent&&n.textContent.trim()===label)||null;}function valueContainerFromLabel(labelNode){if(!labelNode)return null;let c=labelNode.closest("div,section,li,dl,tr")||labelNode.parentElement;for(let i=0;i<8&&c;i++){const t=normText(c.innerText||c.textContent);if(t.length>0&&t!==labelNode.textContent.trim())return c;c=c.parentElement;}return labelNode.parentElement;}function extractValueText(label){const labelNode=findLabelNode(label);if(!labelNode)return null;const c=valueContainerFromLabel(labelNode);if(!c)return null;let t=normText(c.innerText||c.textContent);t=t.replace(/\bBid\b|\bAsk\b|\bMark\b|\bLast trade\b|\bPrevious close\b|\bHigh\b|\bLow\b|\bImplied volatility\b|\bVolume\b|\bOpen interest\b|\bDelta\b|\bGamma\b|\bTheta\b|\bVega\b|\bRho\b/g,"").trim();return t||null;}function parseMoneyAndMult(label){const raw=extractValueText(label);if(!raw)return {raw:null,price:null,size:null};const m=moneyRe.exec(raw);const s=multRe.exec(raw);return {raw,price:m?Number(m[1]):null,size:s?Number(String(s[1]).replace(/,/g,"")):null};}function parseMoney(label){const raw=extractValueText(label);if(!raw)return {raw:null,value:null};const m=moneyRe.exec(raw);return {raw,value:m?Number(m[1]):null};}function parsePercent(label){const raw=extractValueText(label);if(!raw)return {raw:null,value:null};const p=pctRe.exec(raw);if(p)return {raw,value:Number(p[1])};const n=numRe.exec(raw);return {raw,value:n?Number(n[1]):null};}function parseIntLike(label){const raw=extractValueText(label);if(!raw)return {raw:null,value:null};const m=intRe.exec(raw);return {raw,value:m?Number(String(m[1]).replace(/,/g,"")):null};}function parseFloatLike(label){const raw=extractValueText(label);if(!raw)return {raw:null,value:null};const m=numRe.exec(raw);return {raw,value:m?Number(m[1]):null};}function readAll(){const bid=parseMoneyAndMult("Bid");const ask=parseMoneyAndMult("Ask");const mark=parseMoney("Mark");const last=parseMoney("Last trade");const iv=parsePercent("Implied volatility");const volume=parseIntLike("Volume");const oi=parseIntLike("Open interest");const delta=parseFloatLike("Delta");const gamma=parseFloatLike("Gamma");const theta=parseFloatLike("Theta");const vega=parseFloatLike("Vega");const rho=parseFloatLike("Rho");return {bid,ask,mark,last,iv,volume,oi,delta,gamma,theta,vega,rho};}function fmtMoney(v){return v==null?"—":`$${Number(v).toFixed(4)}`;}function fmtPct(v){return v==null?"—":`${Number(v).toFixed(3)}%`;}function fmtInt(v){return v==null?"—":`${Math.trunc(v).toLocaleString()}`;}function makeUI(){const root=document.createElement("div");root.id="rh-opt-tracker";root.style.position="fixed";root.style.top="12px";root.style.right="12px";root.style.zIndex="2147483647";root.style.background="rgba(20,20,20,0.92)";root.style.color="#fff";root.style.font="12px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial";root.style.border="1px solid rgba(255,255,255,0.15)";root.style.borderRadius="12px";root.style.padding="10px";root.style.minWidth="360px";root.style.boxShadow="0 10px 28px rgba(0,0,0,0.4)";root.innerHTML=`<div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">  <div style="font-weight:800;">RH Options Tracker</div>  <div style="display:flex;gap:6px;">    <button id="rhMin" style="cursor:pointer;border:0;background:rgba(255,255,255,0.12);color:#fff;border-radius:8px;padding:4px 8px;">–</button>    <button id="rhClose" style="cursor:pointer;border:0;background:rgba(255,255,255,0.12);color:#fff;border-radius:8px;padding:4px 8px;">X</button>  </div></div><div id="rhBody" style="margin-top:8px;">  <div style="display:grid;grid-template-columns:110px 1fr;gap:4px 10px;align-items:center;">    <div style="opacity:0.8;">Status</div><div id="rhStatus">Starting…</div>    <div style="opacity:0.8;">Bid</div><div id="rhBid">—</div>    <div style="opacity:0.8;">Ask</div><div id="rhAsk">—</div>    <div style="opacity:0.8;">Mark</div><div id="rhMark">—</div>    <div style="opacity:0.8;">Last trade</div><div id="rhLast">—</div>    <div style="opacity:0.8;">Spread</div><div id="rhSpr">—</div>    <div style="opacity:0.8;">Mid</div><div id="rhMid">—</div>    <div style="opacity:0.8;">Implied vol</div><div id="rhIV">—</div>    <div style="opacity:0.8;">Volume</div><div id="rhVolu">—</div>    <div style="opacity:0.8;">Open interest</div><div id="rhOI">—</div>    <div style="opacity:0.8;">Delta</div><div id="rhD">—</div>    <div style="opacity:0.8;">Gamma</div><div id="rhG">—</div>    <div style="opacity:0.8;">Theta</div><div id="rhT">—</div>    <div style="opacity:0.8;">Vega</div><div id="rhV">—</div>    <div style="opacity:0.8;">Rho</div><div id="rhR">—</div>    <div style="opacity:0.8;">Last sample</div><div id="rhTime">—</div>    <div style="opacity:0.8;">Rows</div><div id="rhCount">0</div>  </div>  <div style="margin-top:10px;">    <canvas id="rhChart" width="${CFG.chartWidth}" height="${CFG.chartHeight}" style="border:1px solid rgba(255,255,255,0.12);border-radius:10px;background:rgba(255,255,255,0.04);"></canvas>  </div>  <div style="margin-top:10px;display:flex;gap:6px;flex-wrap:wrap;">    <button id="rhPause" style="cursor:pointer;border:0;background:rgba(255,255,255,0.12);color:#fff;border-radius:10px;padding:6px 10px;">Pause</button>    <button id="rhCopy" style="cursor:pointer;border:0;background:rgba(255,255,255,0.12);color:#fff;border-radius:10px;padding:6px 10px;">Copy CSV</button>    <button id="rhDl" style="cursor:pointer;border:0;background:rgba(255,255,255,0.12);color:#fff;border-radius:10px;padding:6px 10px;">Download CSV</button>    <button id="rhClear" style="cursor:pointer;border:0;background:rgba(255,255,255,0.12);color:#fff;border-radius:10px;padding:6px 10px;">Clear</button>  </div>  <div style="margin-top:10px;max-height:110px;overflow:auto;border-top:1px solid rgba(255,255,255,0.12);padding-top:8px;">    <div style="opacity:0.75;margin-bottom:6px;">Recent</div>    <pre id="rhRecent" style="margin:0;white-space:pre;opacity:0.95;"></pre>  </div></div>`;document.body.appendChild(root);const $=q=>root.querySelector(q);let minimized=false;$("#rhMin").onclick=()=>{minimized=!minimized;$("#rhBody").style.display=minimized?"none":"block";$("#rhMin").textContent=minimized?"+":"–";};$("#rhClose").onclick=()=>api.close();return{root,$};}function drawChart(canvas,series){const ctx=canvas.getContext("2d");ctx.clearRect(0,0,canvas.width,canvas.height);if(series.length<2)return;let min=Infinity,max=-Infinity;for(const v of series){if(v<min)min=v;if(v>max)max=v;}if(min===max){min*=0.999;max*=1.001;}const w=canvas.width,h=canvas.height,pX=6,pY=6,xSpan=w-2*pX,ySpan=h-2*pY,n=series.length;ctx.beginPath();for(let i=0;i<n;i++){const x=pX+(i/(n-1))*xSpan;const y=pY+(1-(series[i]-min)/(max-min))*ySpan;if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);}ctx.strokeStyle="rgba(255,255,255,0.9)";ctx.lineWidth=1.2;ctx.stroke();ctx.fillStyle="rgba(255,255,255,0.7)";ctx.font="10px system-ui,-apple-system,Segoe UI,Roboto,Arial";ctx.fillText(`mid min ${min.toPrecision(4)}  max ${max.toPrecision(4)}`,8,12);}const state={paused:false,rows:[],midSeries:[],ui:null,observer:null,pollTimer:null,lastKey:""};function toCSV(){const header=["timestamp","bid_price","bid_size","ask_price","ask_size","mark","last_trade","spread","mid","iv_pct","volume","open_interest","delta","gamma","theta","vega","rho"].join(",");const lines=state.rows.map(r=>[r.t,r.bid_price??"",r.bid_size??"",r.ask_price??"",r.ask_size??"",r.mark??"",r.last??"",r.spread??"",r.mid??"",r.iv??"",r.volume??"",r.oi??"",r.delta??"",r.gamma??"",r.theta??"",r.vega??"",r.rho??""].join(","));return [header,...lines].join("\n");}function updateUI(rec){const {$}=state.ui;$("#rhBid").textContent=rec.bid_price!=null?`${fmtMoney(rec.bid_price)}${rec.bid_size!=null?` × ${rec.bid_size}`:""}`:"—";$("#rhAsk").textContent=rec.ask_price!=null?`${fmtMoney(rec.ask_price)}${rec.ask_size!=null?` × ${rec.ask_size}`:""}`:"—";$("#rhMark").textContent=fmtMoney(rec.mark);$("#rhLast").textContent=fmtMoney(rec.last);$("#rhSpr").textContent=rec.spread!=null?fmtMoney(rec.spread):"—";$("#rhMid").textContent=rec.mid!=null?fmtMoney(rec.mid):"—";$("#rhIV").textContent=fmtPct(rec.iv);$("#rhVolu").textContent=fmtInt(rec.volume);$("#rhOI").textContent=fmtInt(rec.oi);$("#rhD").textContent=rec.delta!=null?Number(rec.delta).toFixed(4):"—";$("#rhG").textContent=rec.gamma!=null?Number(rec.gamma).toFixed(4):"—";$("#rhT").textContent=rec.theta!=null?Number(rec.theta).toFixed(4):"—";$("#rhV").textContent=rec.vega!=null?Number(rec.vega).toFixed(4):"—";$("#rhR").textContent=rec.rho!=null?Number(rec.rho).toFixed(4):"—";$("#rhTime").textContent=rec.t;$("#rhCount").textContent=String(state.rows.length);const last=state.rows.slice(-6).map(r=>`${r.t} | bid ${r.bid_price!=null?("$"+r.bid_price.toFixed(4)):"N/A"} | ask ${r.ask_price!=null?("$"+r.ask_price.toFixed(4)):"N/A"} | iv ${r.iv!=null?(r.iv.toFixed(3)+"%"):"N/A"} | vol ${r.volume??"N/A"} | oi ${r.oi??"N/A"}`).join("\n");$("#rhRecent").textContent=last;drawChart(state.ui.root.querySelector("#rhChart"),state.midSeries.slice(-CFG.chartWidth));}function sampleOnce(source){if(state.paused)return;const t=ts();const d=readAll();const bidP=d.bid.price,askP=d.ask.price;const spread=(bidP!=null&&askP!=null)?(askP-bidP):null;const mid=(bidP!=null&&askP!=null)?((bidP+askP)/2):null;const key=[bidP,d.bid.size,askP,d.ask.size,d.mark.value,d.last.value,d.iv.value,d.volume.value,d.oi.value,d.delta.value,d.gamma.value,d.theta.value,d.vega.value,d.rho.value].join("|");if(key===state.lastKey&&source!=="poll")return;state.lastKey=key;const rec={t,bid_price:bidP??null,bid_size:d.bid.size??null,ask_price:askP??null,ask_size:d.ask.size??null,mark:d.mark.value??null,last:d.last.value??null,spread,mid,iv:d.iv.value??null,volume:d.volume.value??null,oi:d.oi.value??null,delta:d.delta.value??null,gamma:d.gamma.value??null,theta:d.theta.value??null,vega:d.vega.value??null,rho:d.rho.value??null,source};const anyFound=(rec.bid_price!=null||rec.ask_price!=null||rec.mark!=null||rec.iv!=null||rec.delta!=null);state.ui.$("#rhStatus").textContent=anyFound?`Running (${source})`:"Couldn’t find fields — keep the Stats/Greeks visible";if(!anyFound)return;state.rows.push(rec);if(rec.mid!=null)state.midSeries.push(rec.mid);if(state.rows.length>CFG.maxPoints){state.rows.shift();if(state.midSeries.length>CFG.maxPoints)state.midSeries.shift();}updateUI(rec);}function start(){if(document.getElementById("rh-opt-tracker"))return;state.ui=makeUI();const {$}=state.ui;$("#rhPause").onclick=()=>{state.paused=!state.paused;$("#rhPause").textContent=state.paused?"Resume":"Pause";$("#rhStatus").textContent=state.paused?"Paused":"Running";};$("#rhClear").onclick=()=>{state.rows.length=0;state.midSeries.length=0;state.lastKey="";$("#rhCount").textContent="0";$("#rhRecent").textContent="";$("#rhStatus").textContent="Cleared";const c=state.ui.root.querySelector("#rhChart").getContext("2d");c.clearRect(0,0,CFG.chartWidth,CFG.chartHeight);};$("#rhCopy").onclick=async()=>{const csv=toCSV();try{await navigator.clipboard.writeText(csv);alert("Copied CSV.");}catch(e){prompt("Copy CSV:",csv);} };$("#rhDl").onclick=()=>{const csv=toCSV();const blob=new Blob([csv],{type:"text/csv"});const url=URL.createObjectURL(blob);const a=document.createElement("a");a.href=url;a.download=`rh_option_metrics_${Date.now()}.csv`;a.click();setTimeout(()=>URL.revokeObjectURL(url),1000);};state.observer=new MutationObserver(()=>sampleOnce("observer"));state.observer.observe(document.body,{childList:true,subtree:true,characterData:true});state.pollTimer=setInterval(()=>sampleOnce("poll"),CFG.pollMs);sampleOnce("init");}function stop(){try{state.observer?.disconnect();}catch{}try{clearInterval(state.pollTimer);}catch{}state.pollTimer=null;state.observer=null;state.ui?.root?.remove();}const api={close:()=>{stop();window.__RH_OPT_TRACKER__=null;}};window.__RH_OPT_TRACKER__=api;start();})();
